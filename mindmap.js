const sampleData = {
  id: "root",
  title: "Carto",
  children: [
    {
      id: "c1",
      title: "Data",
      text: "Interpréter le flux de données incessant et débordant qui nous entoure et régit nos vies. Intéragir avec ces masses, les classer, les ranger, les naviguer. Savoir identifier où les données apparaissent, ce que l’on sait sur nous, ce qui s’accumule. La surveillance de masse.",
      children: [
        { id: "c1a", title: "Banques de données" },
        { id: "c1b", title: "Vidéosurveillance" },
        { id: "c1c", title: "Datavisualisation" },
        { id: "c1d", title: "Interfaces" },
        {
          id: "c1e",
          title: "Aram Bartholl",
          link: "https://arambartholl.com",
        },
      ],
    },
    {
      id: "c2",
      title: "Communauté",
      text: "Faire exister des temps, moments et environnements de partages. Comment faire à plusieurs, comment relier des gens à travers des outils et des plateformes, par le web ou en physique. Comment échanger des idées, des formes de luttes, s’indépendantiser du global-web, faire du local-web. Savoir se défendre contre lui, s’anonymiser.",
      children: [
        { id: "c2a", title: "Transhumanisme" },
        { id: "c2b", title: "Hacking ?" },
        { id: "c2c", title: "Cyberféminisme" },
        { id: "c2d", title: "Open-source" },
        { id: "c2e", title: "Collaboration, partage" },
        { id: "c2f", title: "Réseaux de partage, peer-to-peer" },
        { id: "c2g", title: "Protocoles de collaboration" },
        { id: "c2h", title: "Bibliothèques pirates" },
        { id: "c2i", title: "Autodéfense numérique" },
        { id: "c2j", title: "Documentation" },
        { id: "c2k", title: "Non-communication" },
        {
          id: "c2l",
          title: "Multidimensional Link",
          link: "https://multidimensional.link/workshops.html",
        },
        { id: "c2m", title: "CLUB1", link: "https://club1.fr/membres" },
        { id: "c2n", title: "PL4TFORM", link: "https://pl4tform.org/" },
        {
          id: "c2o",
          title: "Design libre",
          link: "https://radicalweb.design/recherche/notes/libre/",
        },
      ],
    },
    {
      id: "c3",
      title: "Web as a standard",
      text: "Utiliser le web comme un outil, avec ses conventions et ses limitations. Faire du méta-design, parler de ce qu’est le web à travers le web. Détourner les conventions, le vernaculaire du web, réutiliser des templates «bootstrap», les modifier, en faire un récit autre.",
      children: [
        {
          id: "c3a",
          title: "Ésotérisme numérique (Temple OS, divine machine)",
        },
        { id: "c3b", title: "Protocoles informatiques détournés, aléatoires" },
        { id: "c3c", title: "Non-esthétique, non-images" },
        {
          id: "c3d",
          title: "Réutilisation et ré-interprétation d’éléments du web",
        },
        { id: "c3e", title: "Éditions par le numérique, transfuge" },
        { id: "c3f", title: "Folklore internet / Vernaculaire du numérique" },
        {
          id: "c3g",
          title: "Net art",
          text: "net =art= (as /in/ interNET ART)",
        },
        {
          id: "c3h",
          title: "Suzanne Treister",
          link: "https://www.suzannetreister.net/",
        },
        {
          id: "c3i",
          title: "Raphaël Bastide",
          link: "https://raphaelbastide.com/",
        },
        {
          id: "c3j",
          title: "Yann Trividic",
          link: "https://www.yanntrividic.fr/?lang=en",
        },
        {
          id: "c3k",
          title: "Digital Folklore Reader",
          link: "https://digitalfolklore.org/",
        },
        {
          id: "c3l",
          title: "Hoverstat.es archive",
          link: "https://www.hoverstat.es/archive/",
        },
        {
          id: "c3m",
          title: "Design libre notes",
          link: "https://radicalweb.design/recherche/notes/libre/",
        },
        {
          id: "c3n",
          title: "HTML Day 2025",
          link: "https://www.are.na/html-energy/websites-made-on-html-day-2025",
        },
        {
          id: "c3o",
          title: "Rosa Menkman",
          link: "https://rosa-menkman.blogspot.com/",
        },
        {
          id: "c3p",
          title: "Folklore notes",
          link: "https://radicalweb.design/recherche/notes/folklore/",
        },
        {
          id: "c3q",
          title: "Web artisanal | Figma Blog",
          link: "https://www.figma.com/fr-fr/blog/making-space-for-a-handmade-web/",
        },
        {
          id: "c3r",
          title: "Olia Lialina",
          link: "https://art.teleportacia.org/observation/vernacular/",
        },
        { id: "c3s", title: "HOVERSTAT.ES", link: "https://www.hoverstat.es/" },
        {
          id: "c3t",
          title: "Instagram",
          link: "https://www.instagram.com/p/C7RY2muI7tR/?img_index=2",
        },
        {
          id: "c3u",
          title: "Sebastian Schmieg",
          link: "https://sebastianschmieg.com/info/",
        },
      ],
    },
    {
      id: "c4",
      title: "Low-Tech",
      text: "(Low Tech : forme de technologie ayant un impact environnemental limité, vivre avec moins) Comment exister à part, être en autarcie numérique. Technologie Off-Grid, itinérante. Re-individualiser le numérique. Se détacher de la course à l’efficacité. Faire du moins, faire autrement.",
      children: [
        {
          id: "c4a",
          title: "Artisanat numérique, web fait main",
          link: "https://luckysoap.com/statements/handmadeweb.html",
        },
        {
          id: "c4b",
          title: "Low-Tech",
          link: "https://damaged.bleu255.com/Low-Tech/",
        },
        {
          id: "c4c",
          title: "Outdoor Computer Club",
          link: "https://alixturcq.club1.fr/outdoorcomputerclub/ressources/",
        },
        {
          id: "c4d",
          title: "Low-Tech Magazine",
          link: "https://solar.lowtechmagazine.com/",
        },
        {
          id: "c4e",
          title: "I feel so much shame ♡",
          link: "https://ifeelsomuchsha.me/",
        },
        { id: "c4f", title: "PL4TFORM", link: "https://pl4tform.org/" },
      ],
    },
  ],
};

const stage = document.getElementById("stage");
const canvas = document.getElementById("links");
const ctx = canvas.getContext("2d");
let nodesById = new Map();
let DPR = Math.max(1, window.devicePixelRatio || 1);

function resizeCanvas() {
  const r = stage.getBoundingClientRect();
  canvas.width = Math.floor(r.width * DPR);
  canvas.height = Math.floor(r.height * DPR);
  canvas.style.width = r.width + "px";
  canvas.style.height = r.height + "px";
  ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
  redraw();
}
window.addEventListener("resize", resizeCanvas);
function rand(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function createNode(data, parent) {
  const node = document.createElement("div");
  node.className = "node";
  node.dataset.id = data.id;
  node.style.left = rand(40, window.innerWidth - 340) + "px";
  node.style.top = rand(40, window.innerHeight - 220) + "px";
  if (!parent) node.classList.add("root-node");
  // add classes based on content
  if (data.img) node.classList.add("has-image");
  if (data.text) node.classList.add("has-text");
  if (data.link) node.classList.add("has-link");
  if (!data.children || !data.children.length) node.classList.add("leaf-node");

  node.innerHTML = `
    <div class="head">
      <div class="title">${escapeHtml(data.title || "Untitled")}</div>
      <div class="controls">
        ${data.children && data.children.length ? '<button class="toggle" title="collapse">−</button>' : ""}
      </div>
    </div>
    <div class="content">
      ${data.text ? `<div class="text">${escapeHtml(data.text)}</div>` : ""}
      ${data.img ? `<img src="${escapeAttr(data.img.src)}" alt="${escapeAttr(data.img.legend || data.title || "image")}" loading="lazy"/>${data.img.legend ? `<div class="legend">${escapeHtml(data.img.legend)}</div>` : ""}` : ""}
      ${data.link ? `<div style="margin-top:6px"><a class="node-link" href="${escapeAttr(data.link)}" target="_blank">${escapeHtml(data.link)}</a></div>` : ""}
    </div>
    <div class="children"></div>`;
  stage.appendChild(node);
  nodesById.set(data.id, {
    el: node,
    data,
    parentId: parent ? parent.id : null,
  });
  const toggleBtn = node.querySelector(".toggle");
  if (toggleBtn) {
    toggleBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      toggleCollapse(data.id);
    });
  }
  makeDraggable(node, data.id);
  if (data.children && data.children.length) {
    for (const child of data.children) {
      createNode(child, data);
    }
  }
}
function escapeHtml(s) {
  return String(s).replace(
    /[&<>"']/g,
    (c) =>
      ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" })[
        c
      ],
  );
}
function escapeAttr(s) {
  return String(s).replace(/"/g, "&quot;");
}

function toggleCollapse(id) {
  const node = nodesById.get(id).el;
  const isCollapsed = node.classList.toggle("collapsed");
  const btn = node.querySelector(".toggle");
  if (btn) btn.textContent = isCollapsed ? "+" : "−";
  const descendants = Array.from(nodesById.values()).filter((n) =>
    isDescendantOf(n.data, id),
  );
  for (const d of descendants) {
    d.el.style.display = isCollapsed ? "none" : "";
  }
  redraw();
}
function isDescendantOf(childData, ancestorId) {
  let cur = nodesById.get(childData.id);
  while (cur && cur.parentId) {
    if (cur.parentId === ancestorId) return true;
    cur = nodesById.get(cur.parentId);
  }
  return false;
}

function makeDraggable(el, id) {
  let ox = 0,
    oy = 0,
    sx = 0,
    sy = 0,
    dragging = false;
  el.addEventListener("pointerdown", (e) => {
    if (e.button !== 0) return;
    e.preventDefault();
    el.classList.add("dragging");
    dragging = true;
    sx = e.clientX;
    sy = e.clientY;
    const rect = el.getBoundingClientRect();
    ox = rect.left;
    oy = rect.top;
    el.setPointerCapture(e.pointerId);
  });
  window.addEventListener("pointermove", (e) => {
    if (!dragging) return;
    const dx = e.clientX - sx;
    const dy = e.clientY - sy;
    const nx = Math.max(
      6,
      Math.min(window.innerWidth - el.offsetWidth - 6, ox + dx),
    );
    const ny = Math.max(
      6,
      Math.min(window.innerHeight - el.offsetHeight - 6, oy + dy),
    );
    el.style.left = nx + "px";
    el.style.top = ny + "px";
    scheduleRedraw();
  });
  window.addEventListener("pointerup", (e) => {
    if (!dragging) return;
    dragging = false;
    el.classList.remove("dragging");
    try {
      el.releasePointerCapture(e.pointerId);
    } catch (_) {}
  });
}

function getNodeCenter(el) {
  const r = el.getBoundingClientRect();
  const stageRect = stage.getBoundingClientRect();
  return {
    x: r.left - stageRect.left + r.width / 2,
    y: r.top - stageRect.top + r.height / 2,
  };
}
function redraw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.lineWidth = 1.6;
  ctx.strokeStyle = "rgba(99,102,241,0.9)";
  ctx.beginPath();
  for (const [id, rec] of nodesById.entries()) {
    if (!rec.parentId) continue;
    const parentRec = nodesById.get(rec.parentId);
    if (!parentRec) continue;
    if (
      rec.el.style.display === "none" ||
      parentRec.el.style.display === "none"
    )
      continue;
    const a = getNodeCenter(parentRec.el);
    const b = getNodeCenter(rec.el);
    const dx = Math.abs(b.x - a.x);
    const cp1 = { x: a.x + dx * 0.3, y: a.y };
    const cp2 = { x: b.x - dx * 0.3, y: b.y };
    ctx.moveTo(a.x, a.y);
    ctx.bezierCurveTo(cp1.x, cp1.y, cp2.x, cp2.y, b.x, b.y);
  }
  ctx.stroke();
}
let redrawRequested = false;
function scheduleRedraw() {
  if (!redrawRequested) {
    redrawRequested = true;
    requestAnimationFrame(() => {
      redrawRequested = false;
      redraw();
    });
  }
}
function buildFromData(root) {
  nodesById.clear();
  stage.innerHTML = "";
  createNode(root, null);
  Array.from(stage.querySelectorAll("img")).forEach((img) => {
    if (!img.complete) img.addEventListener("load", scheduleRedraw);
  });
  resizeCanvas();
}
function randPosition() {
  for (const rec of nodesById.values()) {
    rec.el.style.left =
      rand(20, window.innerWidth - rec.el.offsetWidth - 20) + "px";
    rec.el.style.top =
      rand(20, window.innerHeight - rec.el.offsetHeight - 20) + "px";
  }
}

buildFromData(sampleData);
setInterval(() => scheduleRedraw(), 60);
window.addEventListener("keydown", (e) => {
  if (e.key.toLowerCase() === "r") {
    randPosition();
    scheduleRedraw();
  }
});
window.loadMindData = function (obj) {
  if (!obj || typeof obj !== "object" || !obj.id)
    throw new Error("invalid data");
  buildFromData(obj);
};
resizeCanvas();
